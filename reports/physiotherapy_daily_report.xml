<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_dsl_physiotherapy_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="dsl_hms_physiotherapy_extension._report_physio_body">
                    <t t-set="o" t-value="o"/>
                </t>
            </t>
        </t>
    </template>

    <template id="_report_physio_body">
        <t t-set="company" t-value="o.company_id"/>

        <!-- Header (table-based) -->
        <table class="header-grid">
            <tr>
                <td class="col-left">
                    <img t-if="company.logo"
                         t-att-src="'data:image/png;base64,%s' % (company.logo.decode() if isinstance(company.logo, bytes) else company.logo)"
                         style="max-height:120px; max-width:100%; display:block; margin:0 auto;"/>
                </td>
                <td class="col-center text-center">
                    <h4 class="mb-1">
                        <t t-esc="company.name"/>
                    </h4>
                </td>
                <td class="col-right text-right">
                    <small t-if="company.partner_id and company.partner_id.contact_address"
                           class="d-block pre-line">
                        <t t-esc="company.partner_id.contact_address"/>
                    </small>
                </td>
            </tr>
        </table>

        <hr/>

        <!-- Meta section (bold values) -->
        <t t-if="o.patient_id or o.code or o.visit_count or o.date">
            <table class="meta-grid table table-sm table-borderless">
                <colgroup>
                    <col style="width:50%"/>
                    <col style="width:50%"/>
                </colgroup>
                <tbody>
                    <tr>
                        <!-- Left column: Patient, Code -->
                        <td>
                            <table class="table table-sm table-borderless mb-0">
                                <tr t-if="o.patient_id">
                                    <td class="label-cell">Patient:</td>
                                    <td class="value-cell">
                                        <strong t-esc="o.patient_id.display_name"/>
                                    </td>
                                </tr>
                                <tr t-if="o.code">
                                    <td class="label-cell">Code:</td>
                                    <td class="value-cell">
                                        <strong t-esc="o.code"/>
                                    </td>
                                </tr>
                            </table>
                        </td>

                        <!-- Right column: Total Visit, Date -->
                        <td>
                            <table class="table table-sm table-borderless mb-0 pull-right">
                                <tr t-if="o.visit_count">
                                    <td class="label-cell">Total Visit:</td>
                                    <td class="value-cell">
                                        <strong t-esc="o.visit_count"/>
                                    </td>
                                </tr>
                                <tr t-if="o.date">
                                    <td class="label-cell">Date:</td>
                                    <td class="value-cell">
                                        <strong>
                                            <span t-field="o.date" t-options="{'widget': 'date'}"/>
                                        </strong>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </t>

        <!-- Physiotherapy -->
        <t t-if="o.grp_exercise_ids">
            <div class="mt-3">
                <h6 class="mb-2">Physiotherapy</h6>
                <table class="table table-sm table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th style="width:28%;">Group</th>
                            <th style="width:12%;" class="text-right">Price</th>
                            <th>Exercises</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.grp_exercise_ids" t-as="g">
                            <tr>
                                <td>
                                    <t t-esc="g.group_id.name or ''"/>
                                </td>
                                <td class="text-right">
                                    <t t-if="g.price and g.price != 0.0">
                                        <span t-field="g.price"
                                              t-options="{'widget': 'monetary', 'display_currency': company.currency_id}"/>
                                    </t>
                                </td>
                                <td>
                                    <t t-esc="', '.join([ex.name for ex in g.exercise_ids]) if g.exercise_ids else ''"/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>

        <!-- Lower Limb -->
        <t t-if="o.lower_data_ids.filtered(lambda l: l.right_val or l.left_val or l.sensory_val)">
            <div class="mt-3">
                <h6 class="mb-2">Lower Limb</h6>
                <table class="table table-sm table-bordered fixed">
                    <colgroup>
                        <col style="width:40%"/>
                        <col style="width:20%"/>
                        <col style="width:20%"/>
                        <col style="width:20%"/>
                    </colgroup>
                    <thead class="thead-light">
                        <tr>
                            <th>Name</th>
                            <th>Strength Right</th>
                            <th>Strength Left</th>
                            <th>Sensory</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.lower_data_ids" t-as="l">
                            <t t-if="l.right_val or l.left_val or l.sensory_val">
                                <tr>
                                    <td><t t-esc="l.name or ''"/></td>
                                    <td><t t-esc="l.right_val or ''"/></td>
                                    <td><t t-esc="l.left_val or ''"/></td>
                                    <td><t t-esc="l.sensory_val or ''"/></td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>

        <!-- Upper Limb -->
        <t t-if="o.upper_data_ids.filtered(lambda u: u.right_val or u.left_val or u.sensory_val)">
            <div class="mt-3">
                <h6 class="mb-2">Upper Limb</h6>
                <table class="table table-sm table-bordered fixed">
                    <colgroup>
                        <col style="width:40%"/>
                        <col style="width:20%"/>
                        <col style="width:20%"/>
                        <col style="width:20%"/>
                    </colgroup>
                    <thead class="thead-light">
                        <tr>
                            <th>Name</th>
                            <th>Strength Right</th>
                            <th>Strength Left</th>
                            <th>Sensory</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.upper_data_ids" t-as="u">
                            <t t-if="u.right_val or u.left_val or u.sensory_val">
                                <tr>
                                    <td><t t-esc="u.name or ''"/></td>
                                    <td><t t-esc="u.right_val or ''"/></td>
                                    <td><t t-esc="u.left_val or ''"/></td>
                                    <td><t t-esc="u.sensory_val or ''"/></td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>

        <!-- Hand -->
        <t t-if="o.hand_data_ids.filtered(lambda h: h.right_val or h.left_val or h.sensory_val)">
            <div class="mt-3">
                <h6 class="mb-2">Hand</h6>
                <table class="table table-sm table-bordered fixed">
                    <colgroup>
                        <col style="width:40%"/>
                        <col style="width:20%"/>
                        <col style="width:20%"/>
                        <col style="width:20%"/>
                    </colgroup>
                    <thead class="thead-light">
                        <tr>
                            <th>Name</th>
                            <th>Strength Right</th>
                            <th>Strength Left</th>
                            <th>Sensory</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.hand_data_ids" t-as="h">
                            <t t-if="h.right_val or h.left_val or h.sensory_val">
                                <tr>
                                    <td><t t-esc="h.name or ''"/></td>
                                    <td><t t-esc="h.right_val or ''"/></td>
                                    <td><t t-esc="h.left_val or ''"/></td>
                                    <td><t t-esc="h.sensory_val or ''"/></td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>

        <!-- Reflexes -->
        <t t-if="o.lower_seldata_ids or o.upper_seldata_ids">
            <div class="mt-3">
                <h6 class="mb-2">Reflexes &amp; Strength (Selections)</h6>

                <t t-if="o.lower_seldata_ids">
                    <div class="d-block mb-1">Lower Limb</div>
                    <table class="table table-sm table-bordered fixed">
                        <colgroup>
                            <col style="width:50%"/>
                            <col style="width:25%"/>
                            <col style="width:25%"/>
                        </colgroup>
                        <thead class="thead-light">
                            <tr>
                                <th>Reflexes</th>
                                <th>Strength Right</th>
                                <th>Strength Left</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="o.lower_seldata_ids" t-as="ls">
                                <tr>
                                    <td><t t-esc="ls.name or ''"/></td>
                                    <td><t t-esc="ls.right_val or ''"/></td>
                                    <td><t t-esc="ls.left_val or ''"/></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </t>

                <t t-if="o.upper_seldata_ids">
                    <div class="d-block mb-1">Upper Limb</div>
                    <table class="table table-sm table-bordered fixed">
                        <colgroup>
                            <col style="width:50%"/>
                            <col style="width:25%"/>
                            <col style="width:25%"/>
                        </colgroup>
                        <thead class="thead-light">
                            <tr>
                                <th>Reflexes</th>
                                <th>Strength Right</th>
                                <th>Strength Left</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="o.upper_seldata_ids" t-as="us">
                                <tr>
                                    <td><t t-esc="us.name or ''"/></td>
                                    <td><t t-esc="us.right_val or ''"/></td>
                                    <td><t t-esc="us.left_val or ''"/></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </t>
            </div>
        </t>

        <!-- Notes -->
        <t t-if="o.notes">
            <div class="mt-3">
                <h6 class="mb-2">Notes</h6>
                <div t-esc="o.notes"/>
            </div>
        </t>

        <!-- Signature block -->
        <div class="signature-block">
            <div class="signature-line"></div>
            <div class="sig-label">Signature</div>
        </div>

        <!-- Styles -->
        <style type="text/css">
            /* Header grid */
            .header-grid{ width:100%; border-collapse:collapse; table-layout:fixed; margin-bottom:.5rem;}
            .header-grid td{ vertical-align: middle; }
            .header-grid .col-left{ width:18%; text-align:center; }
            .header-grid .col-center{ width:54%; }
            .header-grid .col-right{ width:28%; }

            /* Utilities */
            .text-center{text-align:center;} .text-right{text-align:right;}
            .mb-0{margin-bottom:0!important;} .mb-1{margin-bottom:.25rem!important;}
            .mb-2{margin-bottom:.5rem!important;} .mt-3{margin-top:1rem!important;}
            .d-block{display:block!important;} .pr-2{padding-right:.5rem!important;}
            .pull-right{margin-left:auto;}
            .pre-line{white-space:pre-line;}

            /* Tables */
            .table{width:100%; border-collapse:collapse; margin-bottom:1rem; color:#212529;}
            .table th,.table td{padding:.5rem; vertical-align:top; border:1px solid #dee2e6;}
            .table-sm th,.table-sm td{padding:.3rem;}
            .table-borderless th,.table-borderless td{border:0!important;}
            .thead-light th{background-color:#f8f9fa; font-weight:600;}
            hr{border:0; border-top:1px solid #adb5bd;}
            .table.fixed{ table-layout: fixed; }

            /* Label/value cells */
            .label-cell{ font-weight: normal; white-space:nowrap; width:90px; padding-right:.5rem; text-align:left; }
            .value-cell{ white-space:nowrap; text-align:left; }

            .meta-grid { margin-top:.25rem; }

            /* Signature */
            .signature-block{
            width:40%;
            margin-left:auto;
            margin-top:3rem;
            text-align:center;
            }
            .signature-line{
            height:0;
            border-top:1px solid #343a40;
            margin-top:4rem;
            }
            .sig-label{ font-size:12px; margin-top:.25rem; }
        </style>
    </template>
</odoo>
