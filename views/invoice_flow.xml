<?xml version="1.0"?>
<odoo>
    <record id="view_physiotherapy_form_inherit_ext" model="ir.ui.view">
        <field name="name">dsl.physiotherapy.form.inherit.ext</field>
        <field name="model">dsl.physiotherapy</field>
        <field name="inherit_id" ref="dsl_hms_physiotherapy.view_physiotherapy_form"/>
        <field name="arch" type="xml">

            <!-- Replace the entire header -->
            <header position="replace">
                <header>
                    <!-- Step 1: Reception refers to doctor -->
                    <button name="action_refer_to_doctor" string="Refer to Doctor"
                            type="object" states="pre_appointment"
                            class="btn-primary"/>

                    <!-- Step 2: Doctor only selects therapy type -->
                    <button name="action_doctor_consultation_done" string="Send for Payment"
                            type="object" states="doctor_consultation"
                            class="btn-success"/>

                    <!-- Step 3: Reception creates invoice (only if no invoice exists and therapy type is selected) -->
                    <button name="action_create_invoice_and_pay" string="Create Invoice"
                            type="object" states="payment_pending"
                            attrs="{'invisible': ['|', '|',
                              ('state','!=','payment_pending'),
                              ('invoice_id','!=',False),
                              ('speechtherapy_type_id','=',False)]}"
                            class="btn-primary"/>

                    <!-- Step 4: Add to queue (only if invoice is paid and queue not generated yet) -->
                    <button name="action_add_to_queue" string="Add to Queue"
                            type="object"
                            states="payment_pending"
                            attrs="{'invisible': ['|', ('invoice_payment_state', '!=', 'paid'), ('queue_number', '>', 0)]}"
                            class="btn-info"/>

                    <!-- Step 5: Start therapy session -->
                    <button name="action_start_therapy" string="Start Therapy"
                            type="object" states="in_queue"
                            class="oe_highlight"/>

                    <!-- Step 6: End therapy session -->
                    <button name="action_end_therapy" string="End Therapy"
                            type="object" states="in_progress"
                            class="oe_highlight"/>

                    <!-- Cancel -->
                    <button name="action_cancel" string="Cancel"
                            type="object"
                            states="pre_appointment,doctor_consultation,payment_pending,in_queue,in_progress"
                            class="btn-secondary"/>

                    <!-- Statusbar -->
                    <field name="state" widget="statusbar"
                           statusbar_visible="pre_appointment,doctor_consultation,payment_pending,in_queue,in_progress,done,cancel"
                           statusbar_colors="{'cancel':'red','done':'green','in_progress':'blue'}"/>
                    <field name="invoice_id" invisible="1"/>
                    <field name="invoice_payment_state" invisible="1"/> <!-- required for attrs -->
                </header>
            </header>

            <!-- Add speechtherapy type field and queue number -->
            <field name="patient_id" position="after">
                <field name="speechtherapy_type_id"
                       attrs="{'readonly': [('state', 'not in', ['doctor_consultation'])],
                               'required': [('state', '=', 'doctor_consultation')]}"/>
                <field name="queue_number" readonly="1"
                       attrs="{'invisible': [('queue_number', '=', 0)]}"/>
            </field>

            <!-- Add session timing fields -->
            <field name="gender" position="after">
                <field name="session_start_time" readonly="1"
                       attrs="{'invisible': [('state', 'not in', ['in_progress','done'])]}"/>

                <field name="session_end_time" readonly="1"
                       attrs="{'invisible': [('state', '!=', 'done')]}"/>

                <field name="session_duration_display" readonly="1"
                       attrs="{'invisible': [('state', '!=', 'done')]}"/>

                <field name="current_session_time" widget="session_timer"
                       attrs="{'invisible': [('state', '!=', 'in_progress')]}"
                       readonly="1"/>
            </field>

        </field>
    </record>
</odoo>